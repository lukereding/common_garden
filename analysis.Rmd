---
title: "common garden tank analysis"
author: "luke reding"
date: "November 8, 2016"
output:
  html_notebook:
    fig_height: 8
    fig_width: 8
    highlight: tango
    theme: journal
    toc: yes
  html_document:
    toc: yes
---

Before we begin...

- LL: large male only tanks
- SS: small male only tanks
- INT: intermediate male only tanks
- LS: large and small male tanks
- FF: female only tanks
- _total courtship_ refers to any sort of courtship-esque event by any male. (We should have Rachel E give us a rigourous def of what she was looking for w/r/t courtship).
- _total aggression_ refers to any sort of aggressive or chase event, regardless of fish identites

**to do:** 

- break things apart by round / replicate

```{r}
library(magrittr)
library(rjson)
library(tidyverse)
library(ggthemes)
library(ggforce)
library(directlabels)


# nice colors:

palette_world <- function(n, random_order = FALSE) {
  cols <- c("#e39d25", "#d16050","#5cb3e7","#4676b1","#818b98","#4c4c4c")
  if (isTRUE(random_order))
    cols <- sample(cols)
  if (length(cols) < n)
    cols <- rep(cols, length.out = n)
  cols[1:n]
}
scale_color_world <- function(...) discrete_scale("colour", "world", palette_world, ...)
scale_fill_world <- function(...) discrete_scale("fill", "world", palette_world, ...)


# helper function: returns NA if the feild doesn't exist, otherwise returns the value
ret <- function(entry){
  if(is.null(entry)){
    return(NA)
  }
  else{
    return(entry)
  }
}

# bitchin' colors
g <- c(0.9649929502500952, 0.9531129905215493, 0.9191510752734625, 0.8593537612656912, 0.8817604211736523, 0.7700023490859729, 0.7161563289278935, 0.8232880086631527, 0.6542005475652726, 0.561817977440984, 0.7615832423359858, 0.5861204102347762, 0.43022162338501957, 0.6871358461951652, 0.5600145030589199,0.3290447800273386, 0.587268798255875, 0.5516378970902409, 0.26991762664572966, 0.46791931434441575, 0.5330773688488463, 0.24073795863422207, 0.34003177164489373, 0.4786370052053605, 0.21805042635421357, 0.22328637568306292, 0.38237877700552625, 0.17250549177124488, 0.11951843162770594, 0.24320155229883056)
greens <- c()
for(i in seq(1, length(g), by = 3)){
  greens %<>% c(rgb(g[i], g[1+i], g[2+i]))
}
greens <- colorRampPalette(greens)

di <- c("#0072B2", "#009E73", "#D55E00", "#CC79A7", "#F0E442", "#65B4E9")
diverging <- function(n){
  return(rep(di,10)[1:n])
}


theme_clean <- function(font_size = 14, font_family = "", line_size = .5) {
  half_line <- 9
  small_rel <- 0.8
  small_size <- small_rel * font_size

  theme_tufte(base_size = font_size, base_family = font_family) %+replace%
    theme(
      rect              = element_rect(fill = "transparent", colour = NA, color = NA, size = 0, linetype = 0),
      text              = element_text(family = font_family, face = "plain", colour = "black",
                                       size = font_size, hjust = 0.5, vjust = 0.5, angle = 0, lineheight = .9,
                                       margin = ggplot2::margin(), debug = FALSE),
      axis.text         = element_text(colour = "black", size = small_size),
      #axis.title        = element_text(face = "bold"),
      axis.text.x       = element_text(margin = ggplot2::margin(t = small_size / 4), vjust = 1),
      axis.text.y       = element_text(margin = ggplot2::margin(r = small_size / 4), hjust = 1),
      axis.title.x      = element_text(
        margin = ggplot2::margin(t = small_size / 2, b = small_size / 4)
      ),
      axis.title.y      = element_text(
        angle = 90,
        margin = ggplot2::margin(r = small_size / 2, l = small_size / 4),
      ),
      axis.ticks        = element_line(colour = "black", size = line_size),
      axis.line.x       = element_blank(),
      axis.line.y       = element_blank(),
      legend.key        = element_blank(),
      legend.spacing     = grid::unit(0.1, "cm"),
      legend.key.size   = grid::unit(1, "lines"),
      legend.text       = element_text(size = rel(small_rel)),
      legend.title      = element_text(size=rel(small_rel)),
      #    legend.position   = c(-0.03, 1.05),
      # legend.justification = c("left", "right"),
      panel.background  = element_blank(),
      panel.border      = element_blank(),
      panel.grid.major  = element_blank(),
      panel.grid.minor  = element_blank(),
      strip.text        = element_text(size = rel(small_rel)),
      strip.background  = element_blank(),
      plot.background   = element_blank(),
      plot.title        = element_text(hjust = 0,
                                       size = font_size*1.2,
                                       margin = ggplot2::margin(b = half_line))
    )
}
# 
# theme_mod <- function(font_size = 14, font_family = "", line_size = .5) {
#   half_line <- font_size / 2
#   small_rel <- 0.8
#   small_size <- small_rel * font_size
# 
#   theme_grey(base_size = font_size, base_family = font_family) %+replace%
#     theme(
#       rect              = element_rect(fill = "transparent", colour = NA, color = NA, size = 0, linetype = 0),
#       text              = element_text(family = font_family, face = "plain", colour = "black",
#                                        size = font_size, hjust = 0.5, vjust = 0.5, angle = 0, lineheight = .9,
#                                        margin = ggplot2::margin(), debug = FALSE),
#       axis.text         = element_text(colour = "black", size = small_size),
#       #axis.title        = element_text(face = "bold"),
#       axis.text.x       = element_text(margin = ggplot2::margin(t = small_size / 4), vjust = 1),
#       axis.text.y       = element_text(margin = ggplot2::margin(r = small_size / 4), hjust = 1),
#       axis.title.x      = element_text(size = font_size*0.9,
#         margin = ggplot2::margin(t = small_size / 3, b = small_size / 4)
#       ),
#       axis.title.y      = element_text(size = font_size*0.9,
#         angle = 90,
#         margin = ggplot2::margin(r = small_size / 3, l = small_size / 4),
#       ),
#       axis.ticks        = element_line(colour = "black", size = line_size),
#       axis.line         = element_line(colour = "black", size = line_size),
#       # the following two lines are not needed for ggplot2 2.2.0 or later
#       axis.line.x         = element_line(colour = "black", size = line_size),
#       axis.line.y         = element_line(colour = "black", size = line_size),
#       legend.key        = element_blank(),
#       legend.key.size   = grid::unit(1, "lines"),
#       legend.text       = element_text(size = rel(small_rel)),
#       #    legend.position   = c(-0.03, 1.05),
#       #    legend.justification = c("left", "top"),
#       panel.background  = element_blank(),
#       panel.border      = element_blank(),
#       panel.grid.major  = element_blank(),
#       panel.grid.minor  = element_blank(),
#       strip.text        = element_text(size = rel(small_rel)),
#       strip.background  = element_blank(),
#       plot.background   = element_blank(),
#       plot.title        = element_text(face = "plain",
#                                        size = font_size,
#                                        margin = ggplot2::margin(b = half_line), hjust = 0),
# 
#       complete = TRUE
#     )
# }

require(ggthemes)
theme_set(theme_clean())

```

Import json files.

```{r}
files <- list.files("/Users/lukereding/Documents/common_garden/data/", pattern = "*.json", full.names = T)

length(files)
```

We have scored `r length(files)` of these short, 10-second videos.

# reading in the `json` files

Now that we've got the list of the file names, we'll read them in one by one, extract various quantities, and organize everything into a data frame.

#### example json file

A single json file looks something like this:

```{r}

rjson::fromJSON(file=files[5])

```


```{r, message=F, warning=F, include = F}

library(rjson)

n <- length(files)
# create data frame
df <- data.frame("video_name" = character(n),
                   "large_vs_large" =integer(n),
                   "large_vs_small"= integer(n),
                   "int_vs_int"= integer(n),
                   "large_vs_female"= integer(n),
                   "small_vs_female"= integer(n),
                   "int_vs_female"= integer(n),
                   "female_vs_female"= integer(n),
                   "female_vs_male"= integer(n),
                   "large_courting"= integer(n),
                   "intermediate_courting"= integer(n),
                   "small_courting"= integer(n),
                   "number_focal"= integer(n),
                   "number_large_male"= integer(n),
                   "number_small_male"= integer(n),
                   "number_model_female"= integer(n),
                   "male_chased_juvenile"= integer(n),
                   "tank_id"= character(n),
                   "pairwise_distance_large_males"= double(n),
                   "pairwise_distance_small_males"= double(n),
                   "pairwise_distance_females"= double(n),
                   "pairewise_distance_juvs"= double(n),
                   "total_fish"= integer(n),
                   "date"= character(n),
                 "comments" = character(n),
                 "small_vs_small" = integer(n),
                 "observer" = character(n),
                 stringsAsFactors=FALSE)



for(i in 1:length(files)){
  # read in data
  json_data <- rjson::fromJSON(file=files[i])
  # print(i)
  # extract the data
  df$video_name[i] <-  ret(json_data$video_name) %>% as.character
  df$large_vs_large[i] <-  ret(json_data$large_vs_large) %>% as.numeric
  df$large_vs_small[i] <-  ret(json_data$large_vs_small)%>% as.numeric
  df$int_vs_int[i] <-  ret(json_data$int_vs_int)%>% as.numeric
  df$large_vs_female[i] <-  ret(json_data$large_vs_female)%>% as.numeric
  df$small_vs_female[i] <-  ret(json_data$small_vs_female)%>% as.numeric
  df$int_vs_female[i] <-  ret(json_data$int_vs_female)%>% as.numeric
  df$female_vs_female[i] <-  ret(json_data$female_vs_female)%>% as.numeric
  df$female_vs_male[i] <-  ret(json_data$female_vs_male)%>% as.numeric
  df$large_courting[i] <-  ret(json_data$large_courting)%>% as.numeric
  df$intermediate_courting[i] <-  ret(json_data$intermediate_courting)%>% as.numeric
  df$small_courting[i] <-  ret(json_data$small_courting)%>% as.numeric
  df$number_focal[i] <-  ret(json_data$number_focal)%>% as.numeric
  df$number_large_male[i] <-  ret(json_data$number_large_male)%>% as.numeric
  df$number_small_male[i] <-  ret(json_data$number_small_male)%>% as.numeric
  df$number_model_female[i] <-  ret(json_data$number_model_female)%>% as.numeric
  df$male_chased_juvenile[i] <-  ret(json_data$male_chased_juvenile)%>% as.numeric
  df$tank_id[i] <-  ret(json_data$tank_id) %>% as.character
  df$pairwise_distance_large_males[i] <-  ret(json_data$pairwise_distance_large_males)%>% as.numeric
  df$pairwise_distance_small_males[i] <-  ret(json_data$pairwise_distance_small_males)%>% as.numeric
  df$pairwise_distance_females[i] <-  ret(json_data$pairwise_distance_females)%>% as.numeric
  df$pairewise_distance_juvs[i] <-  ret(json_data$pairewise_distance_juvs)%>% as.numeric
  df$total_fish[i] <-  ret(json_data$total_fish)%>% as.numeric
  df$date[i] <-  ret(json_data$date) %>% as.character
  df$comments[i] <-  ret(json_data$comments) %>% as.character
  df$observer[i] <- ret(json_data$observer) %>% as.character
  df$small_vs_small[i] <- ret(json_data$small_vs_small) %>% as.character
  
}

df
# get treatment
df$treatment <- gsub("[[:digit:]]","", df$tank_id)


# make column that denotes the date / tank combo
df %<>% unite(col = id, tank_id, date, remove = FALSE)

```

Now I get get overall courtship events (from small, intermediate, and large males) and total aggression events in the tank.

Note that I use `rowwise` here combined with `sum` inside `mutate` and (importantly) `na.rm=TRUE` to exclude NA's (which are prsumably 0's). This is in contrast to doing something like `mutate(total_courtship = large_courting + small_courting + intermediate_courting)` which will return `NA` if any of these variables are `NA`.


```{r}

# get total courtship events:
# df %<>% mutate(total_courtship = sum(large_courting + small_courting + intermediate_courting, na.rm=TRUE))
df %<>% rowwise %>% mutate(total_courtship =sum(large_courting, small_courting ,intermediate_courting, na.rm=TRUE))

# get overall (total) aggression
df %<>% rowwise %>% mutate(total_aggression = sum(large_vs_large, large_vs_small, int_vs_int, large_vs_female, int_vs_female, female_vs_female, female_vs_male, small_vs_female, na.rm= TRUE))

# get aggression towards females and aggressive towards males
df %<>% 
  mutate(aggression_towards_females_by_males = sum(large_vs_female, int_vs_female, small_vs_female, na.rm= TRUE),
         aggression_towards_males_by_males = sum(large_vs_large, large_vs_small, int_vs_int, na.rm= TRUE))

df %<>% ungroup # ungroup by row

```


## look at missing data

```{r}
library(visdat)

vis_dat(df) + scale_fill_world()


```

There are a few variables in this dataset with a lot of missing data. The main ones that stand out:    

- _pairwise distance between small males_: makes sense because this only applies to LS and SS tanks
- _pairwise distance between lage males_: makes sense because this only applies to LS and LL tanks
- _observer_: I didn't add this feild until after version 1.0 of the program
- _small vs small aggression_: same as above

Not also that there are a couple rows that have a lot of missing entries. This is probably because someone forgot to enter 0's into the dialogue boxes.

Overall, these missing data are expected with shouldn't be too problematic.


# wrangling

Now I define a couple functions that are useful went collapsing all the trials from a given day into a single row. This isn't a particularly elegant wasy of doing things, but it works.


```{r}


# function to use to collapse all the videos from one day into a single row
avg_if_numeric <- function(x){
  if(!is.character(x)){
    return(mean(x, na.rm=T))
  }
  else{
    if(length(levels(factor(x))) > 1){
      warning("you are trying to collapse non-matching characters. will take the first one, but beware.")
    }
    return(x[1])
  }
}

sum_if_numeric <- function(x){
  if(!is.character(x)){
    return(sum(x, na.rm=T))
  }
  else{
    if(length(levels(factor(x))) > 1){
      warning("you are trying to collapse non-matching characters. will take the first one, but beware.")
    }
    return(x[1])
  }
}


```


I now create two data frame. `df_avg` contains average behaviors from one of these videos. `df` contains sums.

__Why do we need two data frames?__

For some of the videos, for whatever reason, we only have two instead of three short videos. If we want to use all the data we have, we should use `df_avg` because data from tanks where we only have two videos are comparable to tanks where we have three videos. If we want to be conservative and make sure we have a totally complete three short videos for each tank / week, we can use `df.`


```{r}

df$date %<>% as.Date(format = "%m-%d-%Y")


# fix typo
require(forcats)
df %<>%
  mutate(treatment = fct_recode(treatment,
    "FF"    = "LFF"
  )) 

# reorder treatments
df$treatment %<>% factor(levels = c("LL", "LS", "SS", "INT", "FF"))


# to get the sum total of each behavior for each day
# exclude videos for which there are fewer than three json files
# first get the names of the videos for which there are 3 videos analyzed
good_videos = df %>% 
  group_by(id) %>% 
  tally %>% 
  filter(n ==3) %>% 
  .$id
df$good_video <- ifelse(df$id %in% good_videos, TRUE, FALSE)

# the dataframe containing the averages
df_avg <- df %>% 
  group_by(id) %>% 
  summarise_each(funs(if(is.numeric(.)) mean(., na.rm = TRUE) else first(.)))

df_avg$date %<>% as.Date(format = "%m-%d-%Y")
df_avg$treatment %<>% factor

# the more complete dataframe containing the sums
df %<>% 
  filter(good_video == TRUE) %>% 
  group_by(id) %>% 
  summarise_each(funs(if(is.numeric(.)) sum(., na.rm = TRUE) else first(.)))


```


`df_avg` has `r nrow(df_avg)` rows while `df` has `r nrow(df)`, meaning that we're missing some data for `r nrow(df_avg) - nrow(df)` videos.



Below I use `df_avg` for all the plots. Thus the yaxis is always the **average number of behaviors per 10 sec video**.


-----------

# visualizing the dataset

## define function for post-hoc labeling of groups

We can use the function define below to (1) do a permutational ANOVA, (2) do Tukey post-hoc testing, and (3) add labels to the plots showing which groups are signficantly different from other groups:

(things to add: overall anova significance)

```{r}



generate_label_df <- function(x, y, dataframe){
  require(lmPerm)
  require(multcompView)
  require(magrittr)
  arguments <- as.list(match.call())
  # do the anova
  model <- aovp(eval(arguments$y, dataframe) ~ eval(arguments$x, dataframe), data = dataframe)
  print(summary(model))
  if(summary(model)[[1]][5][1,] > 0.05){
    warning("the ANOVA is not significant")
  }
  
HSD <- TukeyHSD(model, ordered = FALSE, conf.level = 0.95)
  print(HSD)
  
  # Extract labels and factor levels from Tukey post-hoc 
  Tukey.levels <- HSD[[1]][,4]
  Tukey.labels <- multcompLetters(Tukey.levels)['Letters']
  plot.labels <- names(Tukey.labels[['Letters']])
  
  boxplot.df <- split(dataframe, eval(arguments$x, dataframe)) %>%
    lapply(., function(z) eval(arguments$y, z)) %>%
    lapply(., max, na.rm=T) %>%
    unlist# %>%
    #add(((range(.)[2] - range(.)[1])))
  
  boxplot.df <- data.frame(
    height = boxplot.df,
    names(boxplot.df)
  )
  names(boxplot.df)[2] <- "plot.labels"

  # Create a data frame out of the factor levels and Tukey's homogenous group letters
  plot.levels <- data.frame(plot.labels, 
                            labels = Tukey.labels[['Letters']],
                            stringsAsFactors = FALSE)
  
  # Merge it with the labels
  labels.df <- merge(plot.levels, boxplot.df, sort = FALSE)
  print(labels.df)
  
  return(labels.df)
}

```

Example useage:

```{r}

ggplot(df_avg, aes(y=total_courtship, x=treatment)) + 
  geom_boxplot() +
  geom_text(data = generate_label_df(x = treatment, y = total_courtship,df_avg), 
            aes(x = plot.labels, y = height, label = labels), vjust = -1)


```

Groups that share a little have means that do not differ statistically.


## time trends

First we look at some time trends. 

### courtship and coersion

```{r}
require(ggthemes)
require(ggrepel)
# for adding sample sizes to plots
give.n <- function(x){
  return(c(y = median(x)*1.02, label = length(x))) 
  # experiment with the multiplier to find the perfect position
}

ggplot(df_avg, aes(date, total_aggression, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=3)) +
  geom_smooth(se=F)+
  theme_clean() + 
  geom_point(position = position_dodge(width=3)) +
  ylab("average aggressions per video") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +
  scale_x_date() +
  ggtitle("aggression over time (loess smoothed)") 

```

Often the data points with the lines are a bit overwhelming, so I'm going to exclude the points from now on like this:


```{r}

ggplot(df_avg, aes(date, total_aggression, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=3)) +
  geom_smooth(se=F, size = 2)+
  theme_clean() + 
  ylab("average aggressions per video") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +
  scale_x_date() +
  geom_point(position = position_dodge(width=3)) +
  ggtitle("aggression over time (loess smoothed)")


```


```{r}
ggplot(df_avg, aes(date, total_courtship, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=3)) +
  theme_clean() + 
  geom_smooth(se=F, size = 2)+
  geom_point(position = position_dodge(width=3)) +
  ylab("displays per video") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  scale_x_date() +
  ggtitle("average courtship displays over time")

```



### distance between fish

```{r}

ggplot(df_avg, aes(date, pairewise_distance_juvs, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=1)) +
  theme_clean() + 
  geom_smooth(se=F, size = 2)+
  ylab("average distance between juvs. (pixels)") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +
  geom_point(position = position_dodge(width=3)) +
  scale_x_date() +
  ggtitle("average distance between juvs") 


ggplot(df_avg, aes(date, pairwise_distance_females, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=1)) +
  theme_clean() + 
  geom_smooth(se=F, size = 2)+
  geom_point(position = position_dodge(width=3)) +
  ylab("average distance between females per video") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +
  scale_x_date() +
  ggtitle("average distance between feamles") 

```

### specific aggression measures

```{r}
ggplot(df_avg, aes(date, int_vs_int, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=1)) +
  theme_clean() + 
  geom_smooth(se=F, size = 2)+
  geom_point(position = position_dodge(width=3)) +
  ylab("avg # aggressive events") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +  
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  scale_x_date() +
  ggtitle("int. vs int. aggression over time")


```


```{r}
ggplot(df_avg, aes(date, male_chased_juvenile, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=1)) +
  theme_clean() + 
  geom_smooth(se=F, size = 2)+
  geom_point(position = position_dodge(width=3)) +
  ylab("# aggressive events") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +
  scale_x_date() +
  geom_point(aes(color = treatment))+
  ggtitle("male -> juvenile aggression over time")

ggplot(df_avg, aes(date, large_vs_large, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=1)) +
  theme_clean() + 
  geom_smooth(se=F, size = 2)+
  geom_point(position = position_dodge(width=3)) +
  ylab("# aggressive events") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +
  scale_x_date() +
  geom_point(aes(color = treatment))+
  ggtitle("large -> large aggression over time")

ggplot(df_avg, aes(date, int_vs_female, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=1)) +
  theme_clean() + 
  geom_smooth(se=F, size = 2)+
  geom_point(aes(color = treatment))+
  geom_point(position = position_dodge(width=3)) +
  ylab("# aggressive events") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +
  scale_x_date() +
  geom_point(aes(color = treatment))+
  ggtitle("int -> female aggression over time")

ggplot(df_avg, aes(date, large_vs_female, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=1)) +
  theme_clean() + 
  geom_smooth(se=F, size = 2)+
  geom_point(position = position_dodge(width=3)) +
  ylab("# aggressive events") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +
  scale_x_date() +
  geom_point(aes(color = treatment))+
  ggtitle("large male -> female aggression over time")

```


### fish counts

```{r}

ggplot(df_avg, aes(date, total_fish, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=1)) +
  theme_clean() + 
  geom_smooth(se=F, size = 2)+
  geom_point(position = position_dodge(width=3)) +
  ylab("# of fish") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +
  scale_x_date() +
  ggtitle("total # fish over time")

ggplot(df_avg, aes(date, number_focal, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=1)) +
  theme_clean() + 
  geom_smooth(se=F, size = 2)+
  geom_point(position = position_dodge(width=3)) +
  ylab("# of fish") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +
  scale_x_date() +
  ggtitle("# focal fish over time")


ggplot(df_avg, aes(date, number_large_male, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=1)) +
  theme_clean() + 
  geom_smooth(se=F, size = 2)+
  geom_point(position = position_dodge(width=3)) +
  ylab("# of fish") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +
  scale_x_date() +
  ggtitle("# large or intermediate males over time")

ggplot(df_avg, aes(date, number_model_female, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=1)) +
  theme_clean() + 
  geom_smooth(se=F, size = 2)+
  geom_point(position = position_dodge(width=3)) +
  ylab("# of fish") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +
  scale_x_date() +
  ggtitle("# model females over time")

ggplot(df_avg, aes(date, number_small_male, color = treatment)) + 
  # geom_line(size=1.25, position = position_dodge(width=1)) +
  theme_clean() + 
  geom_smooth(se=F, size = 2)+
  geom_point(position = position_dodge(width=3)) +
  ylab("# of fish") +
  # scale_color_manual(values=greens(5)[2:5]) +
  scale_color_world() +
  scale_x_date() +
  ggtitle("# small males over time")


```


## relations with courtship

```{r}

df_avg %>%
  ggplot(aes(number_focal, total_courtship)) +
  geom_point(aes(color = treatment)) +
  scale_color_world() + 
  geom_smooth(se = F, color = "black") +
  # scale_fill_brewer(palette = "Dark2", guide= F) +
  ylab("total courtship displays") +
  xlab("number focal fish") +
  ggtitle("number of focal fish id'ed vs. total courtship") +
  theme_clean()

# remove outlier
df_avg %>%
  filter(number_focal < 30) %>%
  ggplot(aes(number_focal, total_courtship)) +
  geom_point(aes(color = treatment)) +
  scale_color_world() + 
  geom_smooth(se = F, color = "black") +
  # scale_fill_brewer(palette = "Dark2", guide= F) +
  ylab("total courtship displays") +
  xlab("number focal fish") +
  ggtitle("number of focal fish id'ed vs. total courtship\n(outlier removed)") +
  theme_clean()

df_avg %>%
  filter(number_focal < 30) %>%
  ggplot(aes(number_focal, total_courtship)) +
  geom_point(aes(color = treatment)) +
  scale_color_world() + 
  geom_smooth(se = F, color = "black") +
  # scale_fill_brewer(palette = "Dark2", guide= F) +
  ylab("total courtship displays") +
  xlab("number focal fish") +
  ggtitle("number of focal fish id'ed vs. total courtship\n(outlier removed; separated by treatment)") +
  theme_clean() +
  facet_wrap(~ treatment)


df_avg %>%
  filter(treatment %in% c("LS", "LL")) %>% 
  ggplot(aes(number_large_male, total_courtship)) +
  geom_point(aes(color = treatment)) +
  scale_color_world(guide = F) + 
  geom_smooth(se = F, color = "black") +
  # scale_fill_brewer(palette = "Dark2", guide= F) +
  xlab("number of small males") +
  ylab("total courtship displays") +
  ggtitle("number of large males id'ed vs total courtship") +
  theme_clean() +
  facet_wrap(~ treatment)

df_avg %>%
  ggplot(aes(total_aggression, total_courtship)) +
  geom_point(aes(color = treatment)) +
  scale_color_world() + 
  geom_smooth(se = F, color = "black") +
  # scale_fill_brewer(palette = "Dark2", guide= F) +
  ylab("total courtship displays") +
  xlab("total aggression") +
  ggtitle("total_aggression vs total courtship") +
  theme_clean()

df_avg %>%
  ggplot(aes(total_aggression, total_courtship)) +
  geom_point(aes(color = treatment)) +
  scale_color_world(guide=F) + 
  geom_smooth(se = F, color = "black") +
  # scale_fill_brewer(palette = "Dark2", guide= F) +
  ylab("total courtship displays") +
  xlab("total aggression") +
  ggtitle("total_aggression vs total courtship") +
  theme_clean() +
  facet_wrap(~ treatment)

```


## relationships among numbers of fish identified

```{r}


df_avg %>%
  filter(treatment %in% c("LS", "SS")) %>%
  ggplot(aes(number_focal, number_small_male)) +
  geom_point(aes(color = treatment)) +
  scale_color_world(guide = F) + 
  geom_smooth(se = F, color = "black") +
  # scale_fill_brewer(palette = "Dark2", guide= F) +
  ylab("# small males") +
  xlab("# focal fish") +
  ggtitle("# small males vs. # of focal fish id'ed") +
  theme_clean() +
  facet_wrap(~ treatment)


df_avg %>%
  filter(treatment %in% c("LS", "LL", "INT")) %>%
  ggplot(aes(number_focal, number_large_male)) +
  geom_point(aes(color = treatment)) +
  scale_color_world() + 
  geom_smooth(se = F, aes(color = treatment)) +
  # scale_fill_brewer(palette = "Dark2", guide= F) +
  ylab("# large males") +
  xlab("# focal fish") +
  ggtitle("# large/intermediate males vs. # of focal fish id'ed") +
  theme_clean()


df_avg %>%
  mutate(total_males = number_small_male + number_large_male) %>%
  ggplot(aes(number_focal, total_males)) +
  geom_point(aes(color = treatment)) +
  scale_color_world() + 
  geom_smooth(se = F, aes(color = treatment), size = 2) +
  # scale_fill_brewer(palette = "Dark2", guide= F) +
  ylab("# males") +
  xlab("# focal fish") +
  ggtitle("# males vs. # of focal fish id'ed") +
  theme_clean()

df_avg %>%
  mutate(total_males = number_small_male + number_large_male) %>%
  ggplot(aes(number_model_female, total_males)) +
  geom_point(aes(color = treatment)) +
  scale_color_world() + 
  geom_smooth(se = F, aes(color = treatment), size = 2) +
  # scale_fill_brewer(palette = "Dark2", guide= F) +
  ylab("# males") +
  xlab("# model females") +
  ggtitle("# males vs. # of models fish id'ed") +
  theme_clean()
```


### relationships with aggression

```{r}


df_avg %>%
  ggplot(aes(treatment, total_aggression)) +
  geom_boxplot(aes(fill=treatment), outlier.shape=NA, color = "black") +
  geom_sina(alpha=0.5) +
  scale_fill_world(guide = F) +
  ylab("# aggressions") +
  ggtitle("total # of aggressions per video") +
  theme_clean()+
  geom_text(data = generate_label_df(x = treatment, y = total_aggression, df_avg), 
            aes(x = plot.labels, y = height, label = labels),
            size = 7, vjust = -0.2)



df_avg %>%
  ggplot(aes(treatment, large_vs_large)) +
  geom_boxplot(aes(fill=treatment), outlier.shape=NA) +
  # geom_jitter(width=0.2, height=0) +
  geom_sina()+
  scale_fill_world(guide = F) +
  ylab("# chases towards large males") +
  ggtitle("average # of large -> large aggressions") +
  theme_clean() +
  geom_text(data = generate_label_df(x = treatment, y = large_vs_large, df_avg), 
            aes(x = plot.labels, y = height, label = labels),
            size = 7, vjust = -0.2)



df_avg %>%
  ggplot(aes(treatment, small_vs_female)) +
  geom_boxplot(aes(fill=treatment), outlier.shape=NA) +
  # geom_jitter(width=0.2, height=0) +
  geom_sina()+
  scale_size(name = "number of\ndisplays") + 
  scale_fill_world(guide = F) +
  ylab("# chases towards large males") +
  ggtitle("average # of small -> female aggressions") +
  theme_clean() +
  ylim(0, 4)


df_avg %>%
  ggplot(aes(treatment, aggression_towards_females_by_males)) +
  geom_boxplot(aes(fill=treatment), outlier.shape=NA) +
  # geom_jitter(width=0.2, height=0) +
  geom_sina()+
  scale_fill_world(guide = F) +
  ylab("# chases towards females") +
  ggtitle("average # of males -> female aggressions") +
  theme_clean() +
  ylim(0, 4) +
  geom_text(data = generate_label_df(x = treatment, y = aggression_towards_females_by_males, df_avg), 
            aes(x = plot.labels, y = height, label = labels),
            size = 7, vjust = -0.2)

df_avg %>%
  ggplot(aes(treatment, aggression_towards_males_by_males)) +
  geom_boxplot(aes(fill=treatment), outlier.shape=NA) +
  # geom_jitter(width=0.2, height=0) +
  geom_sina()+
  scale_fill_world(guide = F) +
  ylab("# chases towards females") +
  ggtitle("average # of males -> female aggressions") +
  theme_clean() +
  ylim(0, 4) +
  geom_text(data = generate_label_df(x = treatment, y = aggression_towards_males_by_males, df_avg), 
            aes(x = plot.labels, y = height, label = labels),
            size = 7, vjust = -0.2)
```


### other differences by treatment

Here and below I'm going to try a flexible approach in terms of analyzing things statistically. I'm using a permutation (=non-parametric) linear model using `lmp` and looking for post-doc differences between treatments using `glht` from the `multcomp` package.

```{r}
require(lmPerm)
require(multcomp)

# df_avg %$% 
# lmp(large_vs_large ~ treatment, data = .) %>%
#   glht(linfct=mcp(treatment="Tukey")) %>%
#   summary

df_avg %>%
  ggplot(aes(treatment, number_model_female)) +
  geom_boxplot(aes(fill=treatment), outlier.shape=NA) +
  # geom_jitter(width=0.2, size=2, height=0) +
  geom_sina() +
  scale_fill_world( guide= F) +
  ylab("# females") +
  ggtitle("number of adult females found per video") +
  theme_clean() +
  scale_size_continuous(range = c(1,6)) +
  geom_text(data = generate_label_df(x = treatment, y = number_model_female, df_avg), 
            aes(x = plot.labels, y = height, label = labels),
            size = 7, vjust = -0.2)

# df_avg %$% 
#   lmp(number_model_female ~ treatment, data = .) %>% 
#   glht(linfct=mcp(treatment="Tukey")) %>% 
#   summary

df_avg %>%
  ggplot(aes(treatment, pairewise_distance_juvs, fill = treatment)) +
  geom_boxplot(outlier.colour = NA) +
  geom_jitter(width=0.2, size=2, height=0) +
  theme_clean() +
  ylab("average # pixels") +
  ggtitle("average distance between focal juveniles") +
  scale_fill_world( guide= F)

df_avg %>%
  ggplot(aes(treatment, total_aggression, fill = treatment)) +
  geom_boxplot(outlier.colour = NA) +
  # geom_jitter(width=0.2, size=2, height=0) +
  geom_sina() +
  theme_clean() +
  scale_fill_world(guide = F) +
  ylab("# aggressions") +
  ggtitle("total aggression by treatment") 
  


df_avg %>%
  ggplot(aes(treatment, pairwise_distance_females)) +
  geom_boxplot(aes(fill=treatment), outlier.shape=NA) +
  # geom_jitter(width=0.2, size=2, height=0) +
  geom_sina() +
  scale_fill_world() +
  ylab("# pixels") +
  ggtitle("distance between models") +
  theme_clean() +
  scale_size_continuous(range = c(1,6)) +
  geom_text(data = generate_label_df(x = treatment, y = pairwise_distance_females, df_avg), 
            aes(x = plot.labels, y = height, label = labels),
            size = 7, vjust = -0.2)

df_avg %>%
  ggplot(aes(treatment, number_focal)) +
  geom_boxplot(aes(fill=treatment), outlier.shape=NA) +
  # geom_jitter(width=0.2, size=2, height=0) +
  geom_sina() +
  scale_fill_world( guide= F) +
  ylab("# females") +
  ggtitle("number of focal fish found per video") +
  theme_clean() +
  scale_size_continuous(range = c(1,6)) +
  geom_text(data = generate_label_df(x = treatment, y = number_focal, df_avg), 
            aes(x = plot.labels, y = height, label = labels),
            size = 7, vjust = -0.2)


df_avg %>%
  ggplot(aes(treatment, pairewise_distance_juvs)) +
  geom_boxplot(aes(fill=treatment), outlier.shape=NA) +
  # geom_jitter(width=0.2, size=2, height=0) +
  geom_sina() +
  scale_fill_world( guide= F) +
  ylab("# pixels") +
  ggtitle("distance between juveniles") +
  theme_clean() +
  scale_size_continuous(range = c(1,6)) +
  geom_text(data = generate_label_df(x = treatment, y = pairewise_distance_juvs, df_avg), 
            aes(x = plot.labels, y = height, label = labels),
            size = 7, vjust = -0.2)



```


```{r}
df_avg %>%
  group_by(treatment) %>% 
  ggplot(aes(treatment, pairwise_distance_large_males)) +
  geom_boxplot(aes(fill=treatment)) +
  geom_sina(method = "d") +
  scale_fill_world(guide= F) +
  scale_colour_continuous(low="grey80", high="forestgreen") +
  ylab("# pixels") +
  ggtitle("distance between large / intermediate males") +
  theme_clean() +
  geom_text(data = generate_label_df(x = treatment, y = pairwise_distance_large_males, df_avg), 
            aes(x = plot.labels, y = height, label = labels),
            size = 7)

# df_avg %$% 
#   lmp(pairwise_distance_large_males ~ treatment, data = .) %>% 
#   glht(linfct=mcp(treatment="Tukey")) %>% 
#   summary
df_avg %>%
  ggplot(aes(y=female_vs_male, x=treatment)) + 
    geom_boxplot(aes(fill = treatment), outlier.NA = NA) +
    theme_clean() +
    xlab("treatment") +
    ylab("average # of behaviors") +
  ggtitle("female -> male aggressive events") +
  scale_fill_world(guide = F) +
    geom_text(data = generate_label_df(x = treatment, y = female_vs_male, df_avg), 
              aes(x = plot.labels, y = height, label = labels),
              size = 7, vjust = -0.2)
    
  
ggplot(df_avg, aes(y=female_vs_female, x=treatment)) + 
  geom_boxplot(aes(fill = treatment), outlier.NA = NA) +
  scale_fill_world(guide= F) +
  theme_clean()+
  geom_sina() +
  xlab("treatment") +
  ylab("# aggressive behaviors") +
  ggtitle("female -> female aggressive events") +
  geom_text(data = generate_label_df(x = treatment, y = female_vs_female, df_avg), 
            aes(x = plot.labels, y = height, label = labels),
            size = 7, vjust = -0.2)

ggplot(df_avg, aes(y=large_vs_large, x=treatment)) + 
  geom_boxplot(aes(fill = treatment), outlier.NA = NA) +
  theme_clean() +
  geom_sina() +
  xlab("treatment") +
  ylab("avg # behaviors") +
  ggtitle("large -> large aggressive events") +
  scale_fill_world(guide= F) +
  geom_text(data = generate_label_df(x = treatment, y = large_vs_large, df_avg), 
            aes(x = plot.labels, y = height, label = labels),
            size = 7, vjust = -0.2)
```
### other graphs

```{r}

ggplot(df_avg, aes(total_courtship, total_aggression)) + 
  geom_point(aes(color = treatment)) +
  scale_color_world(guide =F) +
  facet_wrap(~ treatment) +
  theme_clean() +
  geom_smooth(aes(color = treatment), se = F, method = lm) +
  ggtitle("relationship between courtship and aggression by treatment") +
  xlab("total # courtship events") +
  ylab("total # aggressive events") 
  
  df_avg %$% 
  lmp(total_aggression ~ total_courtship * treatment, data = .)  %>% 
  anova

```

```{r}


ggplot(df_avg, aes(pairewise_distance_juvs, pairwise_distance_females)) + 
  geom_point(aes(color = treatment)) +
  scale_color_world(guide = F) +
  facet_wrap(~ treatment) +
  theme_clean() +
  ggtitle("relationship between distance b/t juvs and b/t females") +
  xlab("pairwise distance between juvs") +
  ylab("pairwise distance between females") +
  geom_smooth(se=F, aes(color = treatment), method = lm)

  df_avg %$% 
  lmp(pairewise_distance_juvs ~ pairwise_distance_females * treatment, data = .)  %>% 
  anova

# all together now!
# ggplot(df_avg, aes(pairewise_distance_juvs, pairwise_distance_females)) + 
#   geom_point(aes(color = treatment)) +
#   scale_color_world() +
#   theme_clean() +
#   ggtitle("relationship between distance b/t juvs and b/t females") +
#   xlab("pairwise distance between juvs") +
#   ylab("pairwise distance between females") +
#   geom_smooth(se=F, color = "black")

```




```{r}

ggplot(df_avg, aes(total_aggression, pairewise_distance_juvs)) + 
  geom_point(aes(color = treatment)) +
  scale_color_world(guide = F) +
  facet_wrap(~ treatment) +
  theme_clean() +
  xlab("total aggression") +
  ylab("pairwise distance between juvs") +
  geom_smooth(se=F, method = lm, aes(color = treatment))


  df_avg %$% 
  lmp(pairewise_distance_juvs ~ total_aggression * treatment, data = .)  %>% 
  anova
```

```{r}

ggplot(df_avg, aes(male_chased_juvenile, pairewise_distance_juvs)) + 
  geom_point(aes(color = treatment)) +
  scale_color_world(guide = F) +
  facet_wrap(~ treatment) +
  theme_clean() +
  xlab("male chased juvenile") +
  ylab("pairwise distance between juvs") +
   geom_smooth(se=F, color = "black")


df_avg %$% 
  lmp(pairewise_distance_juvs ~ male_chased_juvenile * treatment, data = .)  %>% 
  anova
```














*************



## figures for the grant 

### sums of behaviors 

```{r include=FALSE}


require(cowplot)

df$treatment %<>% factor(levels = c("LS", "INT", "LL","SS","FF"))

courts <- df %>%
  filter(good_video == TRUE) %>%
  mutate(aggresion_towards_females = large_vs_female + small_vs_female + int_vs_female + female_vs_female) %>%
  ggplot(aes(treatment, total_courtship)) +
  geom_boxplot(aes(fill=treatment), outlier.shape=NA) +
  # geom_jitter(width=0.3, height=0.15, aes(size = aggresion_towards_females)) +
  geom_jitter(width=0.3, height=0) +
  scale_fill_manual(values=c("darkorchid4","darkorchid4",rep("grey50",3)), guide=F) + 
  # scale_size(name = "chases towards\nfemales") + 
  ylab("# courtships per video") +
  # ggtitle("number of courtship events per video") +
  theme_clean() +
  ylim(c(0,8))

towards_females <- df %>%
  filter(good_video == TRUE) %>%
  mutate(aggression_towards_males = large_vs_large + large_vs_small + int_vs_int + female_vs_male) %>%
  mutate(aggresion_towards_females = large_vs_female + small_vs_female + int_vs_female + female_vs_female) %>% 
  ggplot(aes(treatment, aggresion_towards_females)) +
  geom_boxplot(aes(fill=treatment), outlier.shape=NA) +
  # geom_jitter(width=0.3, height=0.15, aes(size = total_courtship)) +
  geom_jitter(width=0.3, height=0) +
  scale_fill_manual(values=c("darkorchid4","darkorchid4",rep("grey50",3)), guide=F) + 
  # scale_size(name = "average displays\nper video") + 
  ylab("# chases towards females per video") +
  theme_clean() +
  ylim(c(0,8)) +
  theme(legend.justification=c(0,1.1), legend.position=c(0.05,1))

(x <- plot_grid(courts, towards_females, labels = c("a","b")))



# as bar plot (for DDIG)
df$treatment <- factor(df$treatment, levels = c("LS", "SS", "LL","FF","INT"))
require(ggthemes)
courts <- df %>%
  filter(good_video == TRUE) %>%
  mutate(aggresion_towards_females = large_vs_female + small_vs_female + int_vs_female) %>%
  group_by(treatment) %>%
  summarize(avg_court = mean(total_courtship, na.rm=T)) %>%
  filter(treatment != "INT") %>%
  ggplot(aes(treatment, avg_court)) +
  geom_bar(aes(fill=treatment), stat = "identity") +
  # geom_jitter(width=0.3, height=0.15, aes(size = aggresion_towards_females)) +
  scale_fill_world(guide = F) + 
  # scale_size(name = "chases towards\nfemales") + 
  ylab("average # courtships per video") +
  # ggtitle("number of courtship events per video") +
  theme_clean() +
  ylim(0,6) +
  ggtitle("courtship") +
  theme(axis.text.x=element_text(angle=45, hjust=1))

cosersion <- df %>%
  filter(good_video == TRUE) %>%
  mutate(aggresion_towards_females =  + small_vs_female + int_vs_female) %>%
  group_by(treatment) %>%
  summarize(avg_coerse = mean(aggresion_towards_females, na.rm=T)) %>%
  filter(treatment != "INT") %>%
  ggplot(aes(treatment, avg_coerse)) +
  geom_bar(aes(fill=treatment), stat = "identity") +
  # geom_jitter(width=0.3, height=0.15, aes(size = aggresion_towards_females)) +
  scale_fill_world(guide = F) + 
  # scale_size(name = "chases towards\nfemales") + 
  ylab("average # coersions per video") +
  # ggtitle("number of courtship events per video") +
  theme_clean() +
  ylim(0,1.5) +
  ggtitle("coersion")
(x <- plot_grid(courts, cosersion, labels=c("a","b")))
x

```

### averages of behaviors


```{r include=FALSE}
require(cowplot)
df_avg$treatment %<>% factor(levels = c("LS", "SS", "LL","FF","INT"))
cols <- c("#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999", "#E69F00")

courts <- df_avg %>%
  mutate(aggresion_towards_females = large_vs_female + small_vs_female + int_vs_female + female_vs_female) %>%
  ggplot(aes(treatment, total_courtship)) +
  geom_boxplot(aes(fill=treatment), outlier.shape=NA) +
  # geom_jitter(width=0.3, height=0.15, aes(size = aggresion_towards_females)) +
  geom_jitter(width=0.3, height=0) +
  scale_fill_manual(values=c("darkorchid4","darkorchid4",rep("grey50",3)), guide=F) + 
  # scale_size(name = "chases towards\nfemales") + 
  ylab("average # courtships per video") +
  # ggtitle("number of courtship events per video") +
  theme_clean() +
  ylim(c(0,4)) 

towards_females <- df_avg %>%
  mutate(aggression_towards_females = large_vs_large + large_vs_small + int_vs_int + female_vs_male) %>%
  ggplot(aes(treatment, aggression_towards_females)) +
  geom_boxplot(aes(fill=treatment), outlier.shape=NA) +
  # geom_jitter(width=0.3, height=0.15, aes(size = total_courtship)) +
  geom_jitter(width=0.3, height=0) +
  scale_fill_manual(values=c("darkorchid4","darkorchid4",rep("grey50",3)), guide=F) + 
  # scale_size(name = "average displays\nper video") + 
  ylab("average # chases towards females per video") +
  theme_clean() +
  ylim(c(0,4)) +
  theme(legend.justification=c(0,1.1), legend.position=c(0.05,1))

(x <- plot_grid(courts, towards_females, labels=c("a","b")))
x



```


```{r}
# as bar plot (for DDIG)
theme_mod <- function(font_size = 16, font_family = "", line_size = .5) {
  half_line <- 9
  small_rel <- 0.8
  small_size <- small_rel * font_size
  
  theme_tufte(base_size = font_size, base_family = font_family) %+replace%
    theme(
      rect              = element_rect(fill = "transparent", colour = NA, color = NA, size = 0, linetype = 0),
      text              = element_text(family = font_family, face = "plain", colour = "black",
                                       size = font_size, hjust = 0.5, vjust = 0.5, angle = 0, lineheight = .9,
                                       margin = ggplot2::margin(), debug = FALSE),
      axis.text         = element_text(colour = "black", size = small_size),
      #axis.title        = element_text(face = "bold"),
      axis.text.x       = element_text(margin = ggplot2::margin(t = small_size / 4), vjust = 1),
      axis.text.y       = element_text(margin = ggplot2::margin(r = small_size / 4), hjust = 1),
      axis.title.x      = element_text(
        margin = ggplot2::margin(t = small_size / 2, b = small_size / 4)
      ),
      axis.title.y      = element_text(
        angle = 90,
        size = font_size * 0.8,
        margin = ggplot2::margin(r = small_size / 2, l = small_size / 4),
      ),
      axis.ticks        = element_line(colour = "black", size = line_size),
      axis.line.x       = element_line(colour = "black", size = line_size),
      axis.line.y       = element_line(colour = "black", size = line_size),
      legend.key        = element_blank(),
      legend.margin     = grid::unit(0.1, "cm"),
      legend.key.size   = grid::unit(1, "lines"),
      legend.text       = element_text(size = rel(small_rel*0.7)),
      legend.title      = element_text(size=rel(small_rel*0.7)),
      #    legend.position   = c(-0.03, 1.05),
      # legend.justification = c("left", "right"),
      panel.background  = element_blank(),
      panel.border      = element_blank(),
      panel.grid.major  = element_blank(),
      panel.grid.minor  = element_blank(),
      strip.text        = element_text(size = rel(small_rel)),
      strip.background  = element_rect(fill="#00000020"),
      plot.background   = element_blank(),
      plot.title        = element_text(face = "plain",
                                       size = font_size,
                                       margin = ggplot2::margin(b = half_line), hjust = 0)
    )
}

require(ggthemes)
limits <- aes(ymax = avg_court + se_court, ymin=avg_court - se_court)
  courts <- df_avg %>%
    mutate(aggresion_towards_females = large_vs_female + small_vs_female + int_vs_female) %>%
    group_by(treatment) %>%
    summarize(avg_court = mean(total_courtship, na.rm=T), se_court = sd(total_courtship, na.rm=T) / n(), sd_court = sd(total_courtship, na.rm=T) ) %>%
    # filter(treatment != "INT") %>%
    ggplot(aes(treatment, avg_court)) +
    geom_bar(aes(fill=treatment), stat = "identity") +
    # geom_jitter(width=0.3, height=0.15, aes(size = aggresion_towards_females)) +
    scale_fill_world(guide=F) + 
    # scale_size(name = "chases towards\nfemales") + 
    ylab("average # courtship\nevents per video") +
    # ggtitle("number of courtship events per video") +
    theme_mod() +
    # ylim(c(0,2)) +
    scale_x_discrete(breaks=c("LS","SS","LL", "FF", "INT"),
          labels=c("large and small males", "only small males", "only large males", "only females", "only intermediate males")) +
    ggtitle("amount of courtship") +
    theme(axis.text.x=element_text(angle=45, hjust=1)) +
    geom_errorbar(limits, position=position_dodge(width=0.9), width=0.1)
  
  limits <- aes(ymax = avg_coerse + se_coerse, ymin=avg_coerse - se_coerse)
  cosersion <- df_avg %>%
    mutate(coerse = small_vs_female + int_vs_female) %>%
    group_by(treatment) %>%
    summarize(avg_coerse = mean(coerse, na.rm=T), se_coerse = sd(coerse, na.rm=T) / n()) %>%
    # filter(treatment != "INT") %>%
    ggplot(aes(treatment, avg_coerse)) +
    geom_bar(aes(fill=treatment), stat = "identity") +
    # geom_jitter(width=0.3, height=0.15, aes(size = aggresion_towards_females)) +
    scale_fill_world(guide=F) + 
    # scale_size(name = "chases towards\nfemales") + 
    ylab("average # coersion\nattempts per video") +
    # ggtitle("number of courtship events per video") +
    theme_mod() +
    scale_x_discrete(breaks=c("LS","SS","LL", "FF", "INT"),
          labels=c("large and small males", "only small males", "only large males", "only females", "only intermediate males")) +
    ylim(c(0,1)) +
    ggtitle("amount of coersion") +
    theme(axis.text.x=element_text(angle=45, hjust=1)) +
    geom_errorbar(limits, position=position_dodge(width=0.9), width=0.1)
  
  
  (x <- plot_grid(courts, cosersion, labels=c("a","b")))
  
  x
```




```{r fig.width = 3, fig.height=6}
# as bar plot (for grants Jan 2017)

cols <- c("#6A2C70","#B83B5E", "#F08A5D", "#FFDC2B", "black")

theme_mod <- function(font_size = 16, font_family = "", line_size = .5) {
  half_line <- 9
  small_rel <- 0.8
  small_size <- small_rel * font_size
  
  theme_tufte(base_size = font_size, base_family = font_family) %+replace%
    theme(
      rect              = element_rect(fill = "transparent", colour = NA, color = NA, size = 0, linetype = 0),
      text              = element_text(family = font_family, face = "plain", colour = "black",
                                       size = font_size, hjust = 0.5, vjust = 0.5, angle = 0, lineheight = .9,
                                       margin = ggplot2::margin(), debug = FALSE),
      axis.text         = element_text(colour = "black", size = small_size),
      #axis.title        = element_text(face = "bold"),
      axis.text.x       = element_text(margin = ggplot2::margin(t = small_size / 4), vjust = 1),
      axis.text.y       = element_text(margin = ggplot2::margin(r = small_size / 4), hjust = 1),
      axis.title.x      = element_text(
        margin = ggplot2::margin(t = small_size / 2, b = small_size / 4)
      ),
      axis.title.y      = element_text(
        angle = 90,
        size = font_size * 0.8,
        margin = ggplot2::margin(r = small_size / 2, l = small_size / 4),
      ),
      axis.ticks        = element_line(colour = "black", size = line_size),
      axis.line.x       = element_line(colour = "black", size = line_size),
      axis.line.y       = element_line(colour = "black", size = line_size),
      legend.key        = element_blank(),
      legend.margin     = grid::unit(0.1, "cm"),
      legend.key.size   = grid::unit(1, "lines"),
      legend.text       = element_text(size = rel(small_rel*0.7)),
      legend.title      = element_text(size=rel(small_rel*0.7)),
      #    legend.position   = c(-0.03, 1.05),
      # legend.justification = c("left", "right"),
      panel.background  = element_blank(),
      panel.border      = element_blank(),
      panel.grid.major  = element_blank(),
      panel.grid.minor  = element_blank(),
      strip.text        = element_text(size = rel(small_rel)),
      strip.background  = element_rect(fill="#00000020"),
      plot.background   = element_blank(),
      plot.title        = element_text(face = "plain",
                                       size = font_size,
                                       margin = ggplot2::margin(b = half_line), hjust = 0)
    )
}


require(ggthemes)
limits <- aes(ymax = avg_court + se_court, ymin=avg_court - se_court)
  courts <- df_avg %>%
    mutate(aggresion_towards_females = large_vs_female + small_vs_female + int_vs_female) %>%
    group_by(treatment) %>%
    summarize(avg_court = mean(total_courtship, na.rm=T) * 4, se_court = sd(total_courtship, na.rm=T) / n(), sd_court = sd(total_courtship, na.rm=T) ) %>%
    # filter(treatment != "INT") %>%
    ggplot(aes(treatment, avg_court)) +
    geom_bar(aes(fill=treatment), stat = "identity") +
    # geom_jitter(width=0.3, height=0.15, aes(size = aggresion_towards_females)) +
    scale_fill_manual(guide=F, values = cols) + 
    # scale_size(name = "chases towards\nfemales") + 
    ylab("average # courtship\nevents per minute") +
    # ggtitle("number of courtship events per video") +
    theme_mod() +
    # ylim(c(0,2)) +
    scale_x_discrete(breaks=c("LS","SS","LL", "FF", "INT"),
          labels=c("large and small males", "only small males", "only large males", "only females", "only intermediate males")) +
    ggtitle("amount of courtship") +
    theme(axis.text.x=element_text(angle=45, hjust=1)) +
    theme(axis.text.x = element_blank()) +
    theme(axis.title.x = element_blank()) +
    geom_errorbar(limits, position=position_dodge(width=0.9), width=0.1)+
    theme(axis.ticks.x = element_blank())
  
  limits <- aes(ymax = avg_coerse + se_coerse, ymin=avg_coerse - se_coerse)
  cosersion <- df_avg %>%
    mutate(coerse = small_vs_female + int_vs_female) %>%
    group_by(treatment) %>%
    summarize(avg_coerse = mean(coerse, na.rm=T) *4, se_coerse = sd(coerse, na.rm=T) / n()) %>%
    # filter(treatment != "INT") %>%
    ggplot(aes(treatment, avg_coerse)) +
    geom_bar(aes(fill=treatment), stat = "identity") +
    # geom_jitter(width=0.3, height=0.15, aes(size = aggresion_towards_females)) +
    scale_fill_manual(guide=F, values = cols) + 
    # scale_size(name = "chases towards\nfemales") + 
    ylab("average # coersion\nattempts per minute") +
    # ggtitle("number of courtship events per video") +
    theme_mod() +
    scale_x_discrete(breaks=c("LS","SS","LL", "FF", "INT"),
          labels=c("large and small males", "only small males", "only large males", "only females", "only intermediate males")) +
    ggtitle("amount of coersion") +
    theme(axis.text.x=element_text(angle=30, hjust=1)) +
    geom_errorbar(limits, position=position_dodge(width=0.9), width=0.1) +
    theme(axis.ticks.x = element_blank()) +
    theme(axis.text.x = element_text(size = 12))
  
  
  (x <- plot_grid(courts, cosersion, align = "v", ncol = 1, labels=c("a","b"), rel_heights = c(1,1.5)))
  
  x
  
  ggsave("~/Desktop/ios_grant/cg_fig.pdf", height = 6, width = 3)
```